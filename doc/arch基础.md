## 分布式系统服务案例
### 分布式系统的架构演变
* 单机
* 拆分：水平拆分和垂直拆分  
    水平拆分是从用户->ng->应用->缓存->db的拆分，往往都各自采用集群
    垂直拆分是将应用根据业务来垂直划分，比如分离为用户，商品，库存，订单，交易，监控，结算，大数据等
* 本质上，分布式系统拆分后演进为微服务系统。也等于rpc调用+配置中心+监控+链路追踪，只不过以spring-cloud为代表的微服务将其封装的更全而已
### 系统服务的需求
* 要求大纲：高可用，高性能，可拓展，可监控，易运维  
### 分布式链路追踪需求
* 例如eagleEye，参考谷歌的dapper论文，也有蚂蚁开源的trace系统，都是基于鹰眼二次开发  
    思路就是全局生成唯一traceId，加span的时间对，以树形结构展示整条链路的耗时，顺序等
    采样速率也是要重点考虑的，否则数据量极为庞大，甚至会影响rpc主题性能.
    采样数据只为做监控，实时性可以牺牲一点，考虑基于消息异步  
    
## 大流量限流与消峰
### 应对大流量手段
* 动静分离，静态不变cdn，动态放后端
* 服务拆分提高系统的鲁棒性
* 扩容
* 缓存
* 分库分表读写分离
* 异步
* 降级
* 限流
* 熔断
### 常见限流算法
* 令牌桶  
    限输入流量，每秒放入的个数限定死。允许一定的突发流量，比如突然整个桶满，桶里的请求都可被服务，但由于输入流量被限制，之后有一段时间内桶内不允许加入请求。超过部分丢弃  
    例如：guava rateLimit
* 漏桶  
    限输出流量（即被服务的流量），超过部分丢弃。输入不限制，随意加，超过部分被放弃。固定速率从桶中拿请求来处理
* 计数器限流  
    比如针对热点商品抢购限流，防止热点单行数据压力过大
* 答题限流  
    如12306
### 消峰方式
* 基于消息  
    activemq 遵循jms,适用于非大规模流量
    rocketmq,kafka，不遵循jms，适用于大规模流量
    rocketmq特性：  
    **  事务消息  
    **  顺序消息  
    **  亿级消息堆积  
    **  分布式特性  
    **  集群与广播  
    **  推拉模式  
    rocketmq部署方式：  
    **  单master  
    **  多master(各自存的数据不一样)  
    **  master-slave同步双写（吞吐量低，数据完全一致）  
    **  master-slave异步复制（切换时存在毫秒级的延迟） 
    rocketmq包含组件： 
    **  consumer,producer  
    **  broker  
    **  nameserver(注册中心)  
## 分布式配置
*  zk
*  diamond
*  disconf
## 数据库
*  alisql:针对互联网大并发做优化  
   比如秒杀，收集秒杀请求，然后批量提交。将mysql串行改成并行，同时在提交时，新的收集已开始  
*  数据库分库分表  

## 参考
架构-人人都是架构师+分布式系统架构落地与瓶颈突破
   